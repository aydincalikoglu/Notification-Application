<!DOCTYPE "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html layout:decorate="~{layout.html}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head layout:fragment="header">

    <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Özel Günler Takvimi</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- fullCalendar -->
    <link rel="stylesheet" th:href="@{/plugins/fullcalendar/main.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/fullcalendar-daygrid/main.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/fullcalendar-timegrid/main.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/fullcalendar-bootstrap/main.min.css}">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <!-- jQuery UI -->
    <script th:src="@{/plugins/jquery-ui/jquery-ui.min.js}"></script>
    <!-- AdminLTE for demo purposes -->
    <script th:src="@{/dist/js/demo.js}"></script>
    <!-- fullCalendar 2.2.5 -->
    <script th:src="@{/plugins/moment/moment.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar/main.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar-daygrid/main.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar-timegrid/main.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar-interaction/main.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar-bootstrap/main.min.js}"></script>
    <script th:src="@{/plugins/fullcalendar/locales-all.js}"></script>

</head>
<body layout:fragment="content">

<div class="wrapper">

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>Özel günler Takvimi</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">Takvim</li>
                        </ol>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3">
                        <div class="sticky-top mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Etkinlik Oluştur</h3>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group" style="width: 100%; margin-bottom: 10px;">
                                        <!--<button type="button" id="color-chooser-btn" class="btn btn-info btn-block dropdown-toggle" data-toggle="dropdown">Color <span class="caret"></span></button>-->
                                        <ul class="fc-color-picker" id="color-chooser">
                                            <li><a class="text-primary" href="#"><i class="fas fa-square"></i></a></li>
                                            <li><a class="text-warning" href="#"><i class="fas fa-square"></i></a></li>
                                            <li><a class="text-success" href="#"><i class="fas fa-square"></i></a></li>
                                            <li><a class="text-danger" href="#"><i class="fas fa-square"></i></a></li>
                                            <li><a class="text-muted" href="#"><i class="fas fa-square"></i></a></li>
                                        </ul>
                                    </div>
                                    <!-- /btn-group -->
                                    <div class="input-group">
                                        <input id="new-event" type="text" class="form-control" placeholder="Başlık">
                                        <div class="input-group-append">
                                            <button id="add-new-event" type="button" class="btn btn-primary">Ekle</button>
                                        </div>
                                        <!-- /btn-group -->
                                    </div>
                                    <!-- /input-group -->
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Taşınabilir Etkinlikler</h4>
                                </div>
                                <div class="card-body">
                                    <!-- the events -->
                                    <div id="external-events">
                                        <div class="checkbox">
                                            <label for="drop-remove">
                                                <input type="checkbox" id="drop-remove" checked>
                                                Taşıyınca silinsin
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Etkinlik silmek için buraya sürükleyin</h4>
                                </div>
                                <div class="card-body">
                                    <!-- the events -->
                                    <div id="calendarTrash" class="external-event bg-danger" style="height: 100px">

                                    </div>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->

                        </div>
                    </div>
                    <!-- /.col -->
                    <div class="col-md-9">
                        <div class="card card-primary">
                            <div class="card-body p-0">
                                <!-- THE CALENDAR -->
                                <div id="calendar"></div>
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <!-- Content Wrapper. Contains page content -->


    <footer class="main-footer">
        <div class="float-right d-none d-sm-block">
            <b>Version</b> 3.0.2-pre
        </div>
        <strong>Copyright &copy; 2014-2019 <a href="http://adminlte.io">AdminLTE.io</a>.</strong> All rights
        reserved.
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->
<!-- Page specific script -->
<script>
    $(function () {

        /* API */
        function request(url, dataToSave, method) {
            return $.ajax({
                type: method,
                url: url,
                async: false,
                data: JSON.stringify(dataToSave),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){ console.log(data)},
                failure: function(errMsg) { alert(errMsg); }
            });
        }


        /* initialize the external events
         -----------------------------------------------------------------*/
        function ini_events(ele) {
            ele.each(function () {

                // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
                // it doesn't need to have a start or end
                var eventObject = {
                    title: $.trim($(this).text()) // use the element's text as the event title
                };

                // store the Event Object in the DOM element so we can get to it later
                $(this).data('eventObject', eventObject);

                // make the event draggable using jQuery UI
                $(this).draggable({
                    zIndex        : 1070,
                    revert        : true, // will cause the event to go back to its
                    revertDuration: 0  //  original position after the drag
                })

            })
        }

        ini_events($('#external-events div.external-event'));

        /* initialize the calendar
         -----------------------------------------------------------------*/
        //Date for the calendar events (dummy data)
        var date = new Date();
        var d    = date.getDate(),
            m    = date.getMonth(),
            y    = date.getFullYear();

        var Calendar = FullCalendar.Calendar;
        var Draggable = FullCalendarInteraction.Draggable;

        var containerEl = document.getElementById('external-events');
        var checkbox = document.getElementById('drop-remove');
        var calendarEl = document.getElementById('calendar');

        // initialize the external events
        // -----------------------------------------------------------------

        var newEventId;
        new Draggable(containerEl, {
            itemSelector: '.external-event',
            eventData: function(eventEl) {

                var newEvent = {
                    "title": eventEl.innerText,
                    "backgroundColor": window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
                    "type": "completed",
                    "status":0
                };
                var url = "/api/events";
                newEventId = request(url, newEvent,"POST").responseText;
                return {
                    id: newEventId,
                    title: eventEl.innerText,
                    backgroundColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
                    borderColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
                    textColor: window.getComputedStyle( eventEl ,null).getPropertyValue('color'),
                };
            }
        });

        function getCompletedEvents() {
            var events = [];

            $('#initial-completed-events').find("div").each(function () {
                var event =
                {
                    id             : $(this).attr("data-id"),
                    title          : $(this).text(),
                    start          : new Date($(this).attr("data-start-date")),
                    end            : new Date($(this).attr("data-end-date")),
                    backgroundColor: $(this).attr("data-color"),
                    borderColor    : $(this).attr("data-color"),
                    allDay: true
                };
                events.push(event)
            });
            return events;
        }

        var calendar = new Calendar(calendarEl, {
            locale: 'tr',
            plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid' ],
            header    : {
                left  : 'prev,next today',
                center: 'title',
                right : 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            //initial events
            events    : getCompletedEvents(),
            durationEditable: true,
            editable  : true,
            droppable : true, // this allows things to be dropped onto the calendar !!!
            drop      : function(info) {
                var date = info.dateStr;
                var title = info.draggedEl.innerText;
                var backgroundColor = $(info.draggedEl).css('background-color');
                var type = "completed";


                var newEvent = {
                    "id":newEventId,
                    "title": title,
                    "backgroundColor": backgroundColor,
                    "type": type,
                    "startDate": date,
                    "endDate": date,
                    "status":1
                };
                var url = "/api/events";
                request(url, newEvent,"POST");

                // is the "remove after drop" checkbox checked?
                if (checkbox.checked) {
                    var deleteUrl = "/api/events/"+$(info.draggedEl).attr("data-id");
                    request(deleteUrl, {},"DELETE");

                    // if so, remove the element from the "Draggable Events" list
                    info.draggedEl.parentNode.removeChild(info.draggedEl);
                }
            },
            eventResize: function(info) {
                var changedEvent = {
                    "id": info.event.id,
                    "title": info.event.title,
                    "backgroundColor": info.event.backgroundColor,
                    "type": "completed",
                    "startDate": moment(info.event.start).format("YYYY-MM-DD"),
                    "endDate": moment(info.event.end).format("YYYY-MM-DD"),
                    "status":1
                };
                var url = "/api/events";
                request(url, changedEvent,"POST");
            },
            eventDrop: function(info) {
                console.log(moment(info.event.end).format("YYYY-MM-DD"));
                var changedEvent = {
                    "id": info.event.id,
                    "title": info.event.title,
                    "backgroundColor": info.event.backgroundColor,
                    "type": "completed",
                    "startDate": moment(info.event.start).format("YYYY-MM-DD"),
                    "endDate": info.event.end !=null ? moment(info.event.end).format("YYYY-MM-DD") : moment(info.event.start).format("YYYY-MM-DD"),
                    "status":1
                };
                var url = "/api/events";
                request(url, changedEvent,"POST");

            },
            eventDragStop: function(info) {
                var jsEvent = info.jsEvent;
                var trashEl = jQuery('#calendarTrash');
                var ofs = trashEl.offset();

                var x1 = ofs.left;
                var x2 = ofs.left + trashEl.outerWidth(true);
                var y1 = ofs.top;
                var y2 = ofs.top + trashEl.outerHeight(true);

                if (jsEvent.pageX >= x1 && jsEvent.pageX<= x2 &&
                    jsEvent.pageY >= y1 && jsEvent.pageY <= y2) {
                    var deleteUrl = "/api/events/"+info.event.id;
                    request(deleteUrl, {},"DELETE");
                    info.event.remove();
                }
            },
            eventClick: function(info) {
                console.log('Event: ' + info.event.title);
                console.log('Event: ' + info.event.id);
                console.log('Coordinates: ' + info.jsEvent.pageX + ',' + info.jsEvent.pageY);
                console.log('View: ' + info.view.type);
                // change the border color just for fun
                info.el.style.borderColor = 'red';
                window.location="/drafts";
            }
        });

        calendar.render();

        // $('#calendar').fullCalendar()

        /* ADDING EVENTS */
        var currColor = '#3c8dbc';//Blue by default
        //Color chooser button
        var colorChooser = $('#color-chooser-btn');
        $('#color-chooser > li > a').click(function (e) {
            e.preventDefault();
            //Save color
            currColor = $(this).css('color');
            //Add color effect to button
            $('#add-new-event').css({
                'background-color': currColor,
                'border-color'    : currColor
            })
        });

        function addEvent(value, bgColor, id) {
            //Create events
            var event = $('<div />');
            event.attr("data-id", id);
            event.css({
                'background-color': bgColor,
                'border-color'    : bgColor,
                'color'           : '#fff'
            }).addClass('external-event');
            event.html(value);
            $('#external-events').prepend(event);

            //Add draggable funtionality
            ini_events(event);
        }

        $('#add-new-event').click(function (e) {
            e.preventDefault();
            //Get value and make sure it is not null
            var val = $('#new-event').val();
            if (val.length == 0) {
                return
            }

            var event = {
                "title": val,
                "backgroundColor": currColor,
                "status":1
            };

            var url = "/api/events";
            $.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(event),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(eventId){
                    console.log(eventId);
                    addEvent(val, currColor, eventId);
                },
                failure: function(errMsg) {
                    alert(errMsg);
                }
            });

            //Remove event from text input
            $('#new-event').val('');
        });

        $('#initial-waiting-events').find("div").each(function () {
            addEvent($(this).text(),$(this).attr("data-color"),$(this).attr("data-id"));
        });
    })
</script>
<div id="initial-waiting-events" class="d-none">
    <th:block th:each="event : ${waitingEvents}">
        <div th:data-color="${event.getBackgroundColor()}" th:data-start-date="${event.getStartDate()}" th:data-end-date="${event.getEndDate()}" th:text="${event.getTitle()}" th:data-id='${event.getId()}'></div>
    </th:block>
</div>
<div id="initial-completed-events" class="d-none">
    <th:block th:each="event : ${completeEvents}">
        <div th:data-color="${event.getBackgroundColor()}" th:data-start-date="${event.getStartDate()}" th:data-end-date="${event.getEndDate()}" th:text="${event.getTitle()}" th:data-id='${event.getId()}'></div>
    </th:block>
</div>
</body>
</html>
